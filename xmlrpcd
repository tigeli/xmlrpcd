#!/usr/bin/perl

use warnings;
use strict;

use HTTP::Daemon::SSL;
use IO::Socket::SSL;
use HTTP::Status;

use Frontier::RPC2;

#-----------------------------------------------------------------------------

my $cert = 'x509/actual.cert.pem';
my $key  = 'x509/actual.key.pem';

my $daemon = new HTTP::Daemon::SSL(
  SSL_cert_file => $cert,
  SSL_key_file  => $key,
  LocalPort => 1638,
  LocalAddr => 'localhost',
  Listen => 1,
  ReuseAddr => 1,
) or die "$!";

my $rpc_server = new Frontier::RPC2();
my $rpc_hash = {
  'sample.sumAndDifference' => sub {
    my ($a, $b) = @_;
    return [$a + $b, $a - $b];
  },
};

while (1) {
  my $c = $daemon->accept or next;
  while (my $req = $c->get_request) {
    if ($req->method ne 'POST') {
      $c->send_error(RC_FORBIDDEN);
    }

    my $xml_resp = $rpc_server->serve(
      $req->content,
      $rpc_hash,
    );

    my $resp = new HTTP::Response(200, 'OK', undef, $xml_resp);

    $c->send_response($resp);
  }
}

#-----------------------------------------------------------------------------
# vim:ft=perl
